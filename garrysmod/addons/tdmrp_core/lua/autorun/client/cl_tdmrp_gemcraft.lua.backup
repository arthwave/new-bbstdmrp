-- cl_tdmrp_gemcraft.lua
-- Client-side gem crafting UI

if not CLIENT then return end

TDMRP = TDMRP or {}
TDMRP.GemUI = TDMRP.GemUI or {}

local UI = TDMRP.GemUI

----------------------------------------------------
-- Globals for current crafting session
----------------------------------------------------
UI.CurrentWeapon = nil
UI.SelectedPrefix = nil
UI.SelectedMaterial = nil
UI.CustomName = ""
UI.CraftPanel = nil
UI.CachedInventory = {}  -- Cache of inventory items for gem counts

----------------------------------------------------
-- Helper: get gem inventory counts
----------------------------------------------------
local function GetGemCount(gemID)
    local total = 0
    
    if not UI.CachedInventory then 
        return 0 
    end
    
    -- CachedInventory is the items array directly (from net.ReadTable)
    for idx, item in pairs(UI.CachedInventory) do
        if item and item.kind == "gem" and item.gem == gemID then
            total = total + (item.amount or 1)
        end
    end
    
    return total
end

----------------------------------------------------
-- Get player's money
----------------------------------------------------
local function GetPlayerMoney()
    local ply = LocalPlayer()
    if ply.DarkRPVars and ply.DarkRPVars.money then
        return ply.DarkRPVars.money
    end
    return 0
end

----------------------------------------------------
-- Calculate craft cost based on weapon tier
----------------------------------------------------
local function GetCraftCost(tier)
    tier = tier or 1
    local tierCosts = {
        [1] = 5000,     -- Common
        [2] = 7500,     -- Uncommon
        [3] = 10000,    -- Rare
        [4] = 15000,    -- Epic
        [5] = 25000,    -- Legendary
    }
    return tierCosts[tier] or 5000
end

----------------------------------------------------
-- Get prefix table (all prefixes, not tier-filtered)
----------------------------------------------------
local function GetPrefixesForTier(tier)
    if not TDMRP then 
        print("[TDMRP GemCraft] ERROR: TDMRP table not loaded!")
        return {} 
    end
    if not TDMRP.Gems then 
        print("[TDMRP GemCraft] ERROR: TDMRP.Gems table not loaded!")
        return {} 
    end
    if not TDMRP.Gems.Prefixes then 
        print("[TDMRP GemCraft] ERROR: TDMRP.Gems.Prefixes table not loaded!")
        return {} 
    end
    
    -- All prefixes are shared across tiers now
    local prefixes = {}
    local totalCount = 0
    
    for id, pref in pairs(TDMRP.Gems.Prefixes) do
        totalCount = totalCount + 1
        prefixes[id] = pref
    end
    
    print("[TDMRP GemCraft] GetPrefixesForTier(" .. tier .. "): loaded " .. totalCount .. " prefixes")
    if totalCount == 0 then
        print("[TDMRP GemCraft] WARNING: TDMRP.Gems.Prefixes is empty!")
        print("[TDMRP GemCraft] Keys in Prefixes table:", next(TDMRP.Gems.Prefixes))
    end
    return prefixes
end

----------------------------------------------------
-- Get suffix table for selected tier
----------------------------------------------------
local function GetSuffixesForTier(tier)
    if not TDMRP or not TDMRP.Gems or not TDMRP.Gems.Suffixes then return {} end
    
    -- Filter suffixes by tier
    local suffixes = {}
    local totalCount = 0
    local tieredCount = 0
    
    for id, suf in pairs(TDMRP.Gems.Suffixes) do
        totalCount = totalCount + 1
        if suf.tier == tier then
            tieredCount = tieredCount + 1
            suffixes[id] = suf
        end
    end
    
    print("[TDMRP GemCraft] GetSuffixesForTier(" .. tier .. "): total=" .. totalCount .. ", tier_specific=" .. tieredCount)
    return suffixes
end

----------------------------------------------------
-- Calculate stat preview with prefix modifiers
----------------------------------------------------
local function CalcPrefixModifiedStats(weapon, prefixID)
    if not TDMRP or not TDMRP.Gems or not TDMRP.Gems.Prefixes then
        return nil
    end
    
    local pref = TDMRP.Gems.Prefixes[prefixID]
    if not pref or not pref.stats then return nil end
    
    local dmg = weapon:GetNWInt("TDMRP_Damage", 0)
    local rpm = weapon:GetNWInt("TDMRP_RPM", 0)
    local acc = weapon:GetNWInt("TDMRP_Accuracy", 0)
    local rec = weapon:GetNWInt("TDMRP_Recoil", 0)
    local han = weapon:GetNWInt("TDMRP_Handling", 0)
    
    local s = pref.stats
    
    if s.damage then dmg = math.floor(dmg * (1 + s.damage)) end
    if s.rpm then rpm = math.floor(rpm * (1 + s.rpm)) end
    if s.accuracy then acc = math.floor(acc * (1 + s.accuracy)) end
    if s.recoil then rec = math.floor(rec * (1 + s.recoil)) end
    if s.handling then han = math.floor(han * (1 + s.handling)) end
    
    acc = math.Clamp(acc, 0, 95)
    rec = math.max(rec, 5)
    han = math.Clamp(han, 0, 250)
    
    return {
        damage = dmg,
        rpm = rpm,
        accuracy = acc,
        recoil = rec,
        handling = han,
    }
end

----------------------------------------------------
-- Main Crafting Panel
----------------------------------------------------
function UI.OpenCraftingMenu(weapon)
    if not IsValid(weapon) or not weapon:IsWeapon() then
        chat.AddText(Color(255, 0, 0), "[TDMRP] No valid weapon selected.")
        return
    end
    
    if TDMRP_IsGun and not TDMRP_IsGun(weapon) then
        chat.AddText(Color(255, 0, 0), "[TDMRP] This weapon cannot be modified.")
        return
    end
    
    UI.CurrentWeapon = weapon
    UI.SelectedPrefix = nil
    UI.SelectedMaterial = "standard"
    UI.CustomName = ""
    
    if IsValid(UI.CraftPanel) then
        UI.CraftPanel:Remove()
    end
    
    -- Request fresh inventory data FIRST
    print("[TDMRP GemCraft] Requesting inventory from server...")
    UI.InventoryReceived = false  -- Flag to track if we got the data
    net.Start("TDMRP_Inventory_Request")
    net.SendToServer()
    print("[TDMRP GemCraft] Inventory request sent")
    
    -- Wait for inventory to actually arrive, with timeout fallback
    local startTime = CurTime()
    local function WaitForInventory()
        if UI.InventoryReceived then
            print("[TDMRP GemCraft] Inventory received, opening UI")
            OpenCraftingMenuDeferred(weapon)
            return
        end
        
        if CurTime() - startTime > 2 then  -- 2 second timeout
            print("[TDMRP GemCraft] Inventory timeout, opening UI anyway")
            OpenCraftingMenuDeferred(weapon)
            return
        end
        
        -- Try again next frame
        timer.Simple(0.01, WaitForInventory)
    end
    
    WaitForInventory()
end

function OpenCraftingMenuDeferred(weapon)
    if not IsValid(weapon) then return end
    
    if IsValid(UI.CraftPanel) then
        UI.CraftPanel:Remove()
    end
    
    local frame = vgui.Create("DFrame")
    frame:SetSize(900, 700)
    frame:Center()
    frame:SetTitle("Gem Crafter")
    frame:SetDraggable(true)
    frame:ShowCloseButton(true)
    
    local weaponTier = weapon:GetNWInt("TDMRP_Tier", 1)
    local weaponClass = weapon:GetClass()
    local isCrafted = weapon:GetNWBool("TDMRP_Crafted", false)
    
    print("[TDMRP GemCraft] OpenCraftingMenu: weaponTier=" .. weaponTier .. ", class=" .. weaponClass .. ", crafted=" .. tostring(isCrafted))
    
    -- Branch based on whether weapon is already crafted
    if isCrafted then
        -- Show upgrade UI (diamond/ruby/amethyst options)
        BuildUpgradeUI(frame, weapon, weaponTier)
    else
        -- Show initial craft UI (prefix/suffix selection)
        BuildCraftUI(frame, weapon, weaponTier)
    end
    
    frame:MakePopup()
    UI.CraftPanel = frame
end

----------------------------------------------------
-- Initial Craft UI (prefix + suffix selection)
----------------------------------------------------
function BuildCraftUI(frame, weapon, weaponTier)
    print("[TDMRP GemCraft] TDMRP.Gems exists:", TDMRP.Gems and "yes" or "no")
    print("[TDMRP GemCraft] TDMRP.Gems.Prefixes count:", TDMRP.Gems and TDMRP.Gems.Prefixes and table.Count(TDMRP.Gems.Prefixes) or "nil")
    
    -------- Top section: weapon preview --------
    local topPanel = vgui.Create("DPanel", frame)
    topPanel:Dock(TOP)
    topPanel:SetHeight(200)
    topPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local weaponModel = vgui.Create("DModelPanel", topPanel)
    weaponModel:Dock(LEFT)
    weaponModel:SetWidth(200)
    weaponModel:SetModel(weapon:GetModel())
    
    -- Center the camera on the model
    local mn, mx = weaponModel.Entity:GetRenderBounds()
    local size = 0
    size = math.max(size, math.abs(mn.x) + math.abs(mx.x))
    size = math.max(size, math.abs(mn.y) + math.abs(mx.y))
    size = math.max(size, math.abs(mn.z) + math.abs(mx.z))
    size = size * 0.5  -- Zoom in 200%
    weaponModel:SetCamPos(Vector(size, size, size))
    weaponModel:SetLookAt((mn + mx) * 0.5)
    
    -- Auto-rotate animation
    weaponModel.Entity:SetAngles(Angle(0, CurTime() * 50 % 360, 0))
    function weaponModel:OnCursorEntered()
        self.Rotating = true
    end
    function weaponModel:OnCursorExited()
        self.Rotating = false
    end
    function weaponModel:LayoutEntity(ent)
        if self.Rotating then
            ent:SetAngles(Angle(0, CurTime() * 100 % 360, 0))
        else
            ent:SetAngles(Angle(0, CurTime() * 30 % 360, 0))
        end
    end
    
    local infoPanel = vgui.Create("DPanel", topPanel)
    infoPanel:Dock(FILL)
    infoPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local infoLabel = vgui.Create("DLabel", infoPanel)
    infoLabel:Dock(TOP)
    infoLabel:SetHeight(150)
    infoLabel:SetWrap(true)
    infoLabel:SetFont("DermaDefault")
    
    local baseName = weapon.PrintName or weapon:GetClass() or "Weapon"
    local tierName = TDMRP.TierNames and TDMRP.TierNames[weaponTier] or ("Tier " .. weaponTier)
    local currentName = weapon:GetNWString("TDMRP_CustomName", baseName)
    
    local infoText = string.format(
        "Weapon: %s\nTier: %s\nCraft Cost: $%s\n\nBase Stats:\nDmg: %d | RPM: %d | Acc: %d | Rec: %d | Han: %d",
        currentName,
        tierName,
        GetCraftCost(weaponTier),
        weapon:GetNWInt("TDMRP_Damage", 0),
        weapon:GetNWInt("TDMRP_RPM", 0),
        weapon:GetNWInt("TDMRP_Accuracy", 0),
        weapon:GetNWInt("TDMRP_Recoil", 0),
        weapon:GetNWInt("TDMRP_Handling", 0)
    )
    
    infoLabel:SetText(infoText)
    
    -------- Middle section: prefix selection --------
    local midPanel = vgui.Create("DPanel", frame)
    midPanel:Dock(TOP)
    midPanel:SetHeight(200)
    midPanel:SetBackgroundColor(Color(50, 50, 50))
    
    local prefixLabel = vgui.Create("DLabel", midPanel)
    prefixLabel:Dock(TOP)
    prefixLabel:SetHeight(25)
    prefixLabel:SetFont("DermaDefault")
    prefixLabel:SetText("Select Emerald Prefix (Stat Modifier):")
    
    local prefixScroll = vgui.Create("DScrollPanel", midPanel)
    prefixScroll:Dock(FILL)
    
    local prefixes = GetPrefixesForTier(weaponTier)
    print("[TDMRP GemCraft] Creating prefix buttons, tier=" .. weaponTier .. ", count=" .. table.Count(prefixes))
    
    if table.Count(prefixes) == 0 then
        local emptyLabel = vgui.Create("DLabel", prefixScroll)
        emptyLabel:Dock(TOP)
        emptyLabel:SetHeight(50)
        emptyLabel:SetText("ERROR: No prefixes loaded! Check console for details.")
        emptyLabel:SetTextColor(Color(255, 0, 0))
        return
    end
    
    -- Store all prefix buttons so DoClick can access them
    local prefixButtons = {}
    
    for prefixID, prefixData in SortedPairs(prefixes) do
        print("[TDMRP GemCraft] Creating button for prefix: " .. tostring(prefixID))
        local btn = vgui.Create("DButton", prefixScroll)
        
        if not btn then
            print("[TDMRP GemCraft] ERROR: Failed to create button!")
            continue
        end
        
        print("[TDMRP GemCraft] Button created successfully: " .. tostring(btn))
        
        if not IsValid(btn) then
            print("[TDMRP GemCraft] ERROR: Button is not valid after creation!")
            continue
        end
        
        btn:SetHeight(30)
        btn:Dock(TOP)
        btn:SetText("")
        btn:SetCursor("hand")
        
        local btnLabel = vgui.Create("DLabel", btn)
        if not IsValid(btnLabel) then
            print("[TDMRP GemCraft] ERROR: Failed to create button label!")
            continue
        end
        
        btnLabel:Dock(FILL)
        btnLabel:SetFont("DermaDefault")
        btnLabel:SetWrap(true)
        
        local modDesc = ""
        if prefixData.stats then
            local s = prefixData.stats
            local parts = {}
            if s.damage then table.insert(parts, string.format("DMG: %+d%%", math.floor(s.damage * 100))) end
            if s.rpm then table.insert(parts, string.format("RPM: %+d%%", math.floor(s.rpm * 100))) end
            if s.accuracy then table.insert(parts, string.format("ACC: %+d%%", math.floor(s.accuracy * 100))) end
            if s.recoil then table.insert(parts, string.format("REC: %+d%%", math.floor(s.recoil * 100))) end
            if s.handling then table.insert(parts, string.format("HAN: %+d%%", math.floor(s.handling * 100))) end
            modDesc = table.concat(parts, " | ")
        end
        
        btnLabel:SetText(string.format("%s: %s", prefixData.name or prefixID, modDesc))
        btnLabel:SetTextColor(Color(255, 255, 255))  -- White text by default
        
        -- Store prefix ID and styling state for click handling
        btn.prefixID = prefixID
        btn.bgColor = Color(50, 50, 50)  -- Dark gray by default
        
        -- Override Paint to use custom background color
        function btn:Paint(w, h)
            draw.RoundedBox(0, 0, 0, w, h, self.bgColor or Color(50, 50, 50))
            return false  -- Don't call default paint
        end
        
        -- Add to buttons table
        table.insert(prefixButtons, btn)
        
        function btn:DoClick()
            UI.SelectedPrefix = self.prefixID
            print("[TDMRP GemCraft] Selected prefix: " .. tostring(self.prefixID))
            
            -- Update all prefix buttons using our stored table
            print("[TDMRP GemCraft] Updating " .. #prefixButtons .. " buttons")
            
            for i, child in pairs(prefixButtons) do
                if IsValid(child) and child.prefixID then
                    if UI.SelectedPrefix == child.prefixID then
                        child.bgColor = Color(100, 200, 100)  -- Bright green when selected
                        local label = child:GetChild(0)
                        if IsValid(label) then
                            label:SetTextColor(Color(0, 0, 0))  -- Black text when selected
                        end
                        print("[TDMRP GemCraft] Set " .. child.prefixID .. " to GREEN")
                    else
                        child.bgColor = Color(50, 50, 50)  -- Dark gray when not selected
                        local label = child:GetChild(0)
                        if IsValid(label) then
                            label:SetTextColor(Color(255, 255, 255))  -- White text when not selected
                        end
                    end
                    child:InvalidateLayout(true)  -- Force button to repaint
                end
            end
            
            -- Trigger stat preview update
            midPanel:InvalidateLayout(true)
        end
    end
    
    -------- Bottom section: gem costs & summary --------
    local bottomPanel = vgui.Create("DPanel", frame)
    bottomPanel:Dock(FILL)
    bottomPanel:SetBackgroundColor(Color(50, 50, 50))
    
    local gemCostLabel = vgui.Create("DLabel", bottomPanel)
    gemCostLabel:Dock(TOP)
    gemCostLabel:SetHeight(60)
    gemCostLabel:SetFont("DermaDefault")
    gemCostLabel:SetWrap(true)
    
    local function UpdateCostLabel()
        local emeraldCount = GetGemCount("blood_emerald")
        local sapphireCount = GetGemCount("blood_sapphire")
        local playerMoney = GetPlayerMoney()
        local cost = GetCraftCost(weaponTier)
        
        local emeraldColor = emeraldCount >= 1 and "255 100 100" or "100 100 100"
        local sapphireColor = sapphireCount >= 1 and "100 100 255" or "100 100 100"
        local moneyColor = playerMoney >= cost and "100 255 100" or "255 100 100"
        
        gemCostLabel:SetText(string.format(
            "Gem Requirements: [Emerald: %d/1] [Sapphire: %d/1]\nMoney Cost: $%d (You have: $%d)",
            emeraldCount, sapphireCount, cost, playerMoney
        ))
    end
    
    UpdateCostLabel()
    
    -- Update label when inventory updates
    local updateHookName = "TDMRP_GemCraft_UpdateCost_" .. math.random(10000, 99999)
    hook.Add("TDMRP_InventoryUpdated", updateHookName, function()
        if not IsValid(frame) then
            hook.Remove("TDMRP_InventoryUpdated", updateHookName)
            return
        end
        UpdateCostLabel()
    end)
    
    -------- Suffix info panel --------
    local suffixInfoLabel = vgui.Create("DLabel", bottomPanel)
    suffixInfoLabel:Dock(TOP)
    suffixInfoLabel:SetHeight(80)
    suffixInfoLabel:SetFont("DermaDefault")
    suffixInfoLabel:SetWrap(true)
    suffixInfoLabel:SetText("Suffixes (Random on Craft):\n(5 random suffixes available for this weapon tier)")
    
    local suffixScroll = vgui.Create("DScrollPanel", bottomPanel)
    suffixScroll:Dock(FILL)
    
    local suffixes = GetSuffixesForTier(weaponTier)
    for suffixID, suffixData in SortedPairs(suffixes) do
        local suffixLabel = vgui.Create("DLabel", suffixScroll)
        suffixLabel:Dock(TOP)
        suffixLabel:SetHeight(25)
        suffixLabel:SetFont("DermaDefault")
        suffixLabel:SetText(string.format("â€¢ %s: %s", suffixData.name or suffixID, suffixData.description or "Unknown effect"))
    end
    
    -------- Buttons at very bottom --------
    local buttonPanel = vgui.Create("DPanel", frame)
    buttonPanel:Dock(BOTTOM)
    buttonPanel:SetHeight(40)
    buttonPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local craftBtn = vgui.Create("DButton", buttonPanel)
    craftBtn:Dock(RIGHT)
    craftBtn:SetWidth(150)
    craftBtn:SetText("Craft Weapon")
    craftBtn:SetFont("DermaDefault")
    
    function craftBtn:DoClick()
        if not UI.SelectedPrefix then
            chat.AddText(Color(255, 0, 0), "[TDMRP] Please select a prefix first.")
            return
        end
        
        local emeraldCount = GetGemCount("blood_emerald")
        local sapphireCount = GetGemCount("blood_sapphire")
        local playerMoney = GetPlayerMoney()
        local cost = GetCraftCost(weaponTier)
        
        if emeraldCount < 1 or sapphireCount < 1 then
            chat.AddText(Color(255, 0, 0), "[TDMRP] You need 1 Emerald and 1 Sapphire.")
            return
        end
        
        if playerMoney < cost then
            chat.AddText(Color(255, 0, 0), "[TDMRP] You don't have enough money ($" .. cost .. ").")
            return
        end
        
        -- Send craft request to server
        net.Start("TDMRP_CraftWeapon")
        net.WriteString(UI.SelectedPrefix)
        net.SendToServer()
        
        chat.AddText(Color(100, 255, 100), "[TDMRP] Crafting...")
        frame:Close()
    end
    
    local closeBtn = vgui.Create("DButton", buttonPanel)
    closeBtn:Dock(RIGHT)
    closeBtn:SetWidth(100)
    closeBtn:SetText("Close")
    closeBtn:SetFont("DermaDefault")
    
    function closeBtn:DoClick()
        frame:Close()
    end
end

----------------------------------------------------
-- Upgrade UI (for already-crafted weapons)
----------------------------------------------------
function BuildUpgradeUI(frame, weapon, weaponTier)
    local currentPrefix = weapon:GetNWString("TDMRP_PrefixID", "")
    local currentSuffix = weapon:GetNWString("TDMRP_SuffixID", "")
    
    -------- Top section: weapon preview --------
    local topPanel = vgui.Create("DPanel", frame)
    topPanel:Dock(TOP)
    topPanel:SetHeight(250)
    topPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local weaponModel = vgui.Create("DModelPanel", topPanel)
    weaponModel:Dock(LEFT)
    weaponModel:SetWidth(200)
    weaponModel:SetModel(weapon:GetModel())
    
    -- Center the camera on the model
    local mn, mx = weaponModel.Entity:GetRenderBounds()
    local size = 0
    size = math.max(size, math.abs(mn.x) + math.abs(mx.x))
    size = math.max(size, math.abs(mn.y) + math.abs(mx.y))
    size = math.max(size, math.abs(mn.z) + math.abs(mx.z))
    size = size * 0.5  -- Zoom in 200%
    weaponModel:SetCamPos(Vector(size, size, size))
    weaponModel:SetLookAt((mn + mx) * 0.5)
    
    -- Auto-rotate animation
    weaponModel.Entity:SetAngles(Angle(0, CurTime() * 50 % 360, 0))
    function weaponModel:OnCursorEntered()
        self.Rotating = true
    end
    function weaponModel:OnCursorExited()
        self.Rotating = false
    end
    function weaponModel:LayoutEntity(ent)
        if self.Rotating then
            ent:SetAngles(Angle(0, CurTime() * 100 % 360, 0))
        else
            ent:SetAngles(Angle(0, CurTime() * 30 % 360, 0))
        end
    end
    
    local infoPanel = vgui.Create("DPanel", topPanel)
    infoPanel:Dock(FILL)
    infoPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local infoLabel = vgui.Create("DLabel", infoPanel)
    infoLabel:Dock(FILL)
    infoLabel:SetWrap(true)
    infoLabel:SetFont("DermaDefault")
    
    local baseName = weapon.PrintName or weapon:GetClass() or "Weapon"
    local tierName = TDMRP.TierNames and TDMRP.TierNames[weaponTier] or ("Tier " .. weaponTier)
    local currentName = weapon:GetNWString("TDMRP_CustomName", baseName)
    
    -- Get prefix/suffix display names
    local prefixName = "None"
    local suffixName = "None"
    
    if currentPrefix ~= "" and TDMRP.Gems and TDMRP.Gems.Prefixes and TDMRP.Gems.Prefixes[currentPrefix] then
        prefixName = TDMRP.Gems.Prefixes[currentPrefix].name or currentPrefix
    end
    
    if currentSuffix ~= "" and TDMRP.Gems and TDMRP.Gems.Suffixes and TDMRP.Gems.Suffixes[currentSuffix] then
        suffixName = TDMRP.Gems.Suffixes[currentSuffix].name or currentSuffix
    end
    
    local infoText = string.format(
        "Weapon: %s\nTier: %s\n\nCurrent Prefix: %s\nCurrent Suffix: %s\n\nCrafted Stats:\nDmg: %d | RPM: %d | Acc: %d | Rec: %d | Han: %d",
        currentName,
        tierName,
        prefixName,
        suffixName,
        weapon:GetNWInt("TDMRP_Damage", 0),
        weapon:GetNWInt("TDMRP_RPM", 0),
        weapon:GetNWInt("TDMRP_Accuracy", 0),
        weapon:GetNWInt("TDMRP_Recoil", 0),
        weapon:GetNWInt("TDMRP_Handling", 0)
    )
    
    infoLabel:SetText(infoText)
    
    -------- Middle section: upgrade gem buttons --------
    local midPanel = vgui.Create("DPanel", frame)
    midPanel:Dock(FILL)
    midPanel:SetBackgroundColor(Color(50, 50, 50))
    
    local upgradeLabel = vgui.Create("DLabel", midPanel)
    upgradeLabel:Dock(TOP)
    upgradeLabel:SetHeight(40)
    upgradeLabel:SetFont("DermaDefault")
    upgradeLabel:SetText("Apply Upgrade Gems:")
    upgradeLabel:SetContentAlignment(5)
    
    -- Diamond button (stat boost)
    local diamondBtn = vgui.Create("DButton", midPanel)
    diamondBtn:Dock(TOP)
    diamondBtn:SetHeight(60)
    diamondBtn:SetText("Blood Diamond - Boost All Stats\n(Not yet implemented)")
    
    -- Ruby button (reroll suffix)
    local rubyBtn = vgui.Create("DButton", midPanel)
    rubyBtn:Dock(TOP)
    rubyBtn:SetHeight(60)
    rubyBtn:SetText("Blood Ruby - Reroll Suffix\n(Not yet implemented)")
    
    -- Amethyst button (reroll prefix)
    local amethystBtn = vgui.Create("DButton", midPanel)
    amethystBtn:Dock(TOP)
    amethystBtn:SetHeight(60)
    amethystBtn:SetText("Blood Amethyst - Reroll Prefix\n(Not yet implemented)")
    
    -------- Bottom: close button --------
    local buttonPanel = vgui.Create("DPanel", frame)
    buttonPanel:Dock(BOTTOM)
    buttonPanel:SetHeight(40)
    buttonPanel:SetBackgroundColor(Color(40, 40, 40))
    
    local closeBtn = vgui.Create("DButton", buttonPanel)
    closeBtn:Dock(FILL)
    closeBtn:SetText("Close")
    closeBtn:SetFont("DermaDefault")
    
    function closeBtn:DoClick()
        frame:Close()
    end
end

----------------------------------------------------
-- Net messages from server
----------------------------------------------------

-- Receive crafting result confirmation
net.Receive("TDMRP_CraftSuccess", function()
    local prefixID = net.ReadString()
    local suffixID = net.ReadString()
    
    chat.AddText(Color(100, 255, 100), "[TDMRP] Weapon crafted! Prefix: " .. prefixID .. ", Suffix: " .. suffixID)
end)

net.Receive("TDMRP_CraftFailed", function()
    local reason = net.ReadString()
    chat.AddText(Color(255, 100, 100), "[TDMRP] Craft failed: " .. reason)
end)

-- Listen for inventory updates from the main inventory module
hook.Add("TDMRP_InventoryUpdated", "TDMRP_GemCraft_InventoryUpdated", function(items)
    print("[TDMRP GemCraft] Inventory updated via hook")
    UI.CachedInventory = items
    UI.InventoryReceived = true
end)

----------------------------------------------------
-- Hook to open UI from F4 menu (if integrated)
----------------------------------------------------

hook.Add("TDMRP_OpenGemCrafter", "TDMRP_GemCrafterHook", function(weapon)
    UI.OpenCraftingMenu(weapon)
end)

print("[TDMRP] cl_tdmrp_gemcraft.lua loaded (gem crafting UI ready)")
